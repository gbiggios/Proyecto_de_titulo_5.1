{% extends 'user/base_user.html' %}

{% block title %}Gestión de Planificaciones{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Menú desplegable para seleccionar talleres -->
    <div class="mb-4">
        <label for="select-taller" class="font-weight-bold">Seleccionar Taller:</label>
        <select id="select-taller" class="form-control" onchange="cambiarTaller(this)">
            {% for taller in talleres %}
                <option value="{{ url_for('docente.docente_planificaciones.ver_planificaciones_taller', taller_id=taller.id) }}"
                        {% if taller.id == taller_seleccionado.id %}selected{% endif %}>
                    {{ taller.nombre }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Título del taller seleccionado -->
    <h2 class="text-lg font-weight-bold mb-4">Planificaciones del Taller: {{ taller_seleccionado.nombre }}</h2>

    <!-- Mostrar planificaciones por mes -->
    <div class="row">
        {% for mes, planificacion in planificaciones_por_mes.items() %}
            {% if planificacion and planificacion.habilidades and planificacion.recursos and planificacion.actividades %}
                <div class="col-md-6 col-12 mb-3">
                    <div class="bg-light p-4 rounded shadow">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="text-lg font-weight-bold">{{ mes.capitalize() }}</h4>
                            <div class="btn-group">
                                <!-- Botón Editar -->
                                <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#editModal" 
                                        data-id="{{ planificacion.id }}"
                                        data-mes="{{ mes }}"
                                        data-habilidades="{{ planificacion.habilidades }}"
                                        data-recursos="{{ planificacion.recursos }}"
                                        data-actividades="{{ planificacion.actividades }}"
                                        data-estado="{{ planificacion.estado }}">
                                    Editar
                                </button>
                                <!-- Botón Eliminar -->
                                <button class="btn btn-light btn-sm" data-toggle="modal" data-target="#deleteModal" 
                                        data-id="{{ planificacion.id }}">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                        <p><strong>Habilidades:</strong> {{ planificacion.habilidades }}</p>
                        <p><strong>Recursos:</strong> {{ planificacion.recursos }}</p>
                        <p><strong>Actividades:</strong> {{ planificacion.actividades }}</p>
                        <p><strong>Estado:</strong> {{ planificacion.estado }}</p>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if puede_crear %}
    <!-- Formulario para crear nueva planificación -->
    <div class="bg-light p-4 rounded shadow mt-4">
        <h4 class="text-lg font-weight-bold">Crear Planificación para {{ siguiente_mes|capitalize }}</h4>
        <form method="POST" action="{{ url_for('docente.docente_planificaciones.crear_planificacion') }}">
            <input type="hidden" name="taller_id" value="{{ taller_seleccionado.id }}">
            <input type="hidden" name="mes" value="{{ siguiente_mes }}">
            <div class="form-group">
                <label for="habilidades">Habilidades</label>
                <textarea id="habilidades" name="habilidades" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label for="recursos">Recursos</label>
                <textarea id="recursos" name="recursos" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label for="actividades">Actividades</label>
                <textarea id="actividades" name="actividades" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado" name="estado" class="form-control" required>
                    <option value="No realizado">No realizado</option>
                    <option value="En desarrollo">En desarrollo</option>
                    <option value="Planificada">Planificada</option>
                </select>
            </div>
            {{ form.hidden_tag() }} <!-- Token CSRF -->
            <button type="submit" class="btn btn-primary mt-2">Guardar Planificación</button>
        </form>
    </div>
    {% else %}
    <div class="alert alert-warning mt-4">
        Debes completar las planificaciones anteriores antes de crear una nueva.
    </div>
    {% endif %}
</div>

<script>
    // Función para cambiar de taller al seleccionar uno del menú desplegable
    function cambiarTaller(select) {
        const url = select.value;
        if (url) {
            window.location.href = url; // Redirige al URL del taller seleccionado
        }
    }

    // Rellenar los campos del modal con los datos de la planificación seleccionada
    $('#editModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Botón que abrió el modal
        var id = button.data('id');
        var mes = button.data('mes');
        var habilidades = button.data('habilidades');
        var recursos = button.data('recursos');
        var actividades = button.data('actividades');
        var estado = button.data('estado');

        var modal = $(this);
        modal.find('#edit_id').val(id);
        modal.find('#editModal_habilidades').val(habilidades);
        modal.find('#editModal_recursos').val(recursos);
        modal.find('#editModal_actividades').val(actividades);
        modal.find('#editModal_estado').val(estado);
    });
</script>
{% endblock %}
